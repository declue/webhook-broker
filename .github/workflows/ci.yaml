name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build TypeScript
        run: npm run build

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Lint Helm chart
        run: helm lint charts/webhook-broker

      - name: Template Helm chart
        run: |
          helm template webhook-broker charts/webhook-broker \
            --set secrets.github.clientId=test \
            --set secrets.github.clientSecret=test \
            --set secrets.github.callbackUrl=http://localhost/callback \
            --set secrets.github.webhookSecret=test \
            --set secrets.jwt.secret=test-jwt-secret-32-chars-long!! \
            --set secrets.encryption.key=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef \
            --set secrets.metrics.token=test-metrics-token-32-chars-long
